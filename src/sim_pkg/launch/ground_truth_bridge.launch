<launch>
  <!-- 地面真值到MAVROS转换桥接 -->
  <!-- 解决无人机高度估计问题 -->
  
  <arg name="uav_id" default="1"/>
  <arg name="model_name" default="p230_0"/>
  <arg name="publish_rate" default="50.0"/>
  <arg name="enable_vision_pose" default="true"/>
  <arg name="enable_mocap" default="true"/>
  
  <!-- Gazebo模型状态到视觉位置估计的转换 -->
  <group ns="/uav$(arg uav_id)">
    
    <!-- 地面真值到视觉位置的转换器 -->
    <node name="ground_truth_to_vision" 
          pkg="sim_pkg" 
          type="ground_truth_to_vision.py" 
          output="screen"
          if="$(arg enable_vision_pose)">
      <param name="model_name" value="$(arg model_name)"/>
      <param name="publish_rate" value="$(arg publish_rate)"/>
      <param name="frame_id" value="map"/>
      <param name="child_frame_id" value="base_link"/>
      
      <!-- 重映射话题 -->
      <remap from="/gazebo/model_states" to="/gazebo/model_states"/>
      <remap from="~vision_pose" to="mavros/vision_pose/pose"/>
      <remap from="~vision_odom" to="mavros/odometry/in"/>
    </node>
    
    <!-- 地面真值到MOCAP的转换器 -->
    <node name="ground_truth_to_mocap" 
          pkg="sim_pkg" 
          type="ground_truth_to_mocap.py" 
          output="screen"
          if="$(arg enable_mocap)">
      <param name="model_name" value="$(arg model_name)"/>
      <param name="publish_rate" value="$(arg publish_rate)"/>
      <param name="frame_id" value="map"/>
      <param name="child_frame_id" value="base_link"/>
      
      <!-- 重映射话题 -->
      <remap from="/gazebo/model_states" to="/gazebo/model_states"/>
      <remap from="~mocap_pose" to="mavros/mocap/pose"/>
    </node>
    
    <!-- 地面真值TF发布器 -->
    <node name="ground_truth_tf_publisher" 
          pkg="tf2_ros" 
          type="static_transform_publisher" 
          args="0 0 0 0 0 0 map odom"/>
    
    <!-- 虚拟GPS发布器（基于地面真值） -->
    <node name="fake_gps_publisher" 
          pkg="sim_pkg" 
          type="fake_gps_from_ground_truth.py" 
          output="screen">
      <param name="model_name" value="$(arg model_name)"/>
      <param name="publish_rate" value="5.0"/>
      
      <!-- GPS原点设置（苏黎世） -->
      <param name="origin_lat" value="47.3667"/>
      <param name="origin_lon" value="8.5500"/>
      <param name="origin_alt" value="408.0"/>
      
      <!-- 重映射话题 -->
      <remap from="/gazebo/model_states" to="/gazebo/model_states"/>
      <remap from="~gps_fix" to="mavros/global_position/global"/>
    </node>
    
    <!-- 高度传感器模拟器 -->
    <node name="altitude_sensor_sim" 
          pkg="sim_pkg" 
          type="altitude_sensor_sim.py" 
          output="screen">
      <param name="model_name" value="$(arg model_name)"/>
      <param name="publish_rate" value="20.0"/>
      <param name="sensor_noise" value="0.01"/>
      
      <!-- 重映射话题 -->
      <remap from="/gazebo/model_states" to="/gazebo/model_states"/>
      <remap from="~altitude" to="mavros/altitude"/>
    </node>
    
  </group>
  
  <!-- 地面高度图发布器（可选） -->
  <node name="ground_height_publisher" 
        pkg="sim_pkg" 
        type="ground_height_publisher.py" 
        output="screen">
    <param name="resolution" value="0.1"/>
    <param name="size_x" value="20.0"/>
    <param name="size_y" value="20.0"/>
    <param name="frame_id" value="map"/>
    
    <!-- 重映射话题 -->
    <remap from="~height_map" to="/ground_height_map"/>
  </node>
  
</launch>
